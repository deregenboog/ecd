{% extends '::base.html.twig' %}
{% import '::html.macro.twig' as html %}

{% set max_depth = 4 %}
{% set col_width = (100/(max_depth))|round(0, 'floor') %}

{% block title %}
    Maatschappelijk werk | {{ title }}
{% endblock %}

{% block subnavigation %}
    {% include '@Mw/subnavigation.html.twig' %}
{% endblock %}

{% block content_top %}
    <h1>{{ entity_name|capitalize }} toevoegen</h1>
{% endblock %}

{% block content %}
    {{ form_start(form) }}
    <div class="col-xs-6">
        {{ form_row(form.medewerker) }}
        {{ form_row(form.datum) }}
        <table class="table table-hover inventarisaties">
        {% for id, categorie in inventarisaties %}
            <tr>
                <th><h4>{{ categorie.rootName }}</h4></th>
                {% for i in range(1, max_depth - 1) %}
                    <th width="{{ col_width }}%"></th>
                {% endfor %}
            </tr>
            {% for inventarisatie in categorie if inventarisatie.depth is defined %}
                <tr>
                    {% if inventarisatie.depth > 1 %}
                        <td colspan="{{ inventarisatie.depth-1 }}"></td>
                    {% endif %}
                    <td colspan="{{ max_depth-inventarisatie.depth+1 }}">
                    {% if 'N' != inventarisatie.actie %}
                        {% set rendered = false %}
                        {% for elm in form.children['inventarisatie_'~id].children if not rendered %}
                            {% if not elm.rendered and elm.vars.label == inventarisatie.titel %}
                                {{ form_row(elm) }}
                                {% set rendered = true %}
                            {% endif %}
                        {% endfor %}
                        {% if 'Doorverwijzer' == inventarisatie.actie %}
                            {{ form_widget(form.children['inventarisatie_doorverwijzer_'~inventarisatie.id]) }}
                            {{ form_errors(form.children['inventarisatie_doorverwijzer_'~inventarisatie.id]) }}
                        {% elseif 'Trajecthouder' == inventarisatie.actie %}
                            {{ form_widget(form.children['inventarisatie_trajecthouder_'~inventarisatie.id]) }}
                            {{ form_errors(form.children['inventarisatie_trajecthouder_'~inventarisatie.id]) }}
                        {% endif %}
                    {% else %}
                        {{ inventarisatie }}
                    {% endif %}
                    </td>
                </tr>
            {% endfor %}
        {% endfor %}
        </table>
        {{ form_row(form.locatie) }}
        {{ form_row(form.contactsoort) }}
        {{ form_row(form.duur) }}
        {{ form_row(form.submit) }}
    </div>
    <div class="col-xs-6">
        {{ form_row(form.opmerking) }}
        {{ form_end(form) }}
        <h2>Vorige verslagen</h2>
        <div style="max-height: 30em; overflow-y: scroll;">
            {% for verslag in entity.klant.verslagen %}
                <h3>Verslag van {{ verslag.datum|date('d-m-Y') }}</h3>
                <div class="row">
                    <div class="col-xs-6">
                        <dl class="dl-horizontal">
                            <dt>Locatie</dt>
                            <dd>{{ verslag.locatie }}</dd>
                            <dt>Medewerker</dt>
                            <dd>{{ verslag.medewerker }}</dd>
                        </dl>
                    </div>
                    <div class="col-xs-6">
                        <dl class="dl-horizontal">
                            <dt>Contactsoort</dt>
                            <dd>{{ verslag.contactsoort }}</dd>
                            {% if verslag.duur %}
                                <dt>Duur</dt>
                                <dd>{{ verslag.duur }} minuten</dd>
                            {% endif %}
                        </dl>
                    </div>
                </div>
                <p class="well">{{ verslag.opmerking|nl2br }}</p>
            {% endfor %}
        </div>
    </div>
{% endblock %}

{% block stylesheets %}
    <style>
        .radio input[type="radio"] {
            position: relative;
            margin-left: 0;
        }
    </style>
{% endblock %}

{% block scripts %}
    <script>
        $(function() {
            var radios = $('table.inventarisaties input[type="radio"]');
            var cellsWithSelect = $('table.inventarisaties td:has(select)');
            var toggleSelect = function() {
                cellsWithSelect.each(function(i, cell) {
                    var radio = $(cell).find('input[type="radio"]');
                    var select = $(cell).children('select');
                    if (radio.is(':checked')) {
                        select.show();
                    } else {
                        select.val('');
                        select.hide();
                    }
                });
            }
            radios.on('change', function() {
                toggleSelect();
            });
            toggleSelect();

            var duurSelect = $('select#verslag_duur');
            var toggleDuur = function() {
                if (1 === $('#verslag_contactsoort label:contains("Face-to-face") input[type="radio"]:checked').length) {
                    duurSelect.closest('.form-group').show();
                } else {
                    duurSelect.val('');
                    duurSelect.closest('.form-group').hide();
                }
            }
            $('#verslag_contactsoort input[type="radio"]').on('change', function() {
                toggleDuur();
            });
            toggleDuur();
        });
    </script>
{% endblock %}
