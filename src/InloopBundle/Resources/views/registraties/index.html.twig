{% extends '::base.html.twig' %}
{% import '::html.macro.twig' as html %}

{% block title %}
    Inloop | {{ title }}
{% endblock %}

{% block subnavigation %}
    {% include '@Inloop/subnavigation.html.twig' %}
{% endblock %}

{% block content %}
    <h1>Bezoekersregistratie voor {{ locatie }}</h1>
    <p>
        <a href="{{ path('inloop_registraties_locationselect') }}">Locatie wijzigen</a>
    </p>
    <ul class="nav nav-tabs">
        {{ html.navLink('Bezoekersregistratie', path('inloop_registraties_index', {locatie: locatie.id}), isActiveRoute('inloop_registraties_index')) }}
        {{ html.navLink('Nu binnen', path('inloop_registraties_active', {locatie: locatie.id}), isActiveRoute('inloop_registraties_active')) }}
        {{ html.navLink('Recent uitgecheckt', path('inloop_registraties_history', {locatie: locatie.id}), isActiveRoute('inloop_registraties_history')) }}
    </ul>
    <div id="content">
        {% include 'InloopBundle:registraties:_index.html.twig' %}
    </div>
{% endblock %}

{% block scripts %}
    <script>
        $(function() {

            var locatie_id = {{ locatie.id }};

            $('#content').on('click', 'table tbody tr', function() {
                var klant_id = $(this).closest('tr').attr('data-id');

                $.get({
                    url: `/inloop/registraties/jsonCanRegister/${klant_id}/${locatie_id}`,
                }).done(function(response) {
                    if (response.allow && response.confirm){
                        var confirmed = confirm(response.message);
                    } else if(response.allow){
                        var confirmed = true;
                    } else {
                        alert(response.message);
                        var confirmed = false;
                    }

                    if (confirmed) {
                        checkin(klant_id, locatie_id);
                    }

                    return true;
                }).fail(function() {
                    alert('Er is een fout opgetreden.')
                });
            });

            function checkin(klant_id, locatie_id) {
                $.post({
                    url: `/inloop/registraties/ajaxAddRegistratie/${klant_id}/${locatie_id}`,
                }).done(function(data) {
                    $('#content').html(data);
                }).fail(function() {
                    alert('Er is een fout opgetreden.')
                });
            };
        });
    </script>
{% endblock %}
