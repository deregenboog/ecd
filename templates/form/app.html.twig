{% use "bootstrap_3_horizontal_layout.html.twig" %}

{% block form_start -%}
    {% if 0 == form.vars.errors|length and not form.vars.valid -%}
        <div class="alert alert-danger" role="alert">
            LET OP! Dit formulier is nog niet opgeslagen. Herstel de fouten in
            dit formulier en klik nogmaals op "Opslaan".
        </div>
    {%- endif %}
        
    {# Add the id attribute to existing form attributes #}
    {% set attr = form.vars.attr|merge({'id': form.vars.id}) %}
    {# Call the parent form_start block with the updated attr variable:
       In theory, this does allow the form to inherit attributes from its parent form,
       create new attributes, or overwrite existing ones #}
    {{ parent(form.vars | merge({'attr': attr})) }}

    <!-- Modal voor Afsluiting Bevestiging -->
    <div class="modal fade" id="afsluitingConfirmModal" tabindex="-1" role="dialog" aria-labelledby="afsluitingModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="afsluitingModalLabel">Bevestig actie</h4>
                </div>
                <div class="modal-body">
                    <!-- De inhoud van de modal body kan dynamisch worden aangepast door JavaScript -->
                    <p>Weet u zeker dat u deze actie wilt uitvoeren?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Annuleren</button>
                    <button type="button" class="btn btn-primary" id="afsluitingConfirmBtn">Bevestigen</button>
                </div>
            </div>
        </div>
    </div>
    {# extra block for form properties #}
    {% block scripts %}
        {# if custom propery has set, then do the magic and show the popup#}
        <script>
            $(document).ready(function() {
                console.log("DOCUMENT READY!");
                const $formToConfirm = $('#afsluiting'); // Target form ID
                const $afsluitingRedenDropdown = $('#afsluiting_reden'); // Dropdown ID for onchange event

                if ($formToConfirm.length) {
                    // Define IDs for the modal and confirm button
                    const modalId = 'afsluitingConfirmModal';
                    const confirmButtonId = 'afsluitingConfirmBtn';

                    const $modalElement = $('#' + modalId);
                    const $confirmButton = $('#' + confirmButtonId);
                    console.log("formToConfirm form is present");
                    // Proceed only if the dropdown, modal, and confirm button exist for the onchange logic
                    if ($afsluitingRedenDropdown.length && $modalElement.length && $confirmButton.length) {
                        console.log("form button and logic are present");
                        // Event listener for the dropdown change
                        $afsluitingRedenDropdown.on('change', function() {
                            console.log("on change the reden dropdown");
                            // Check if the selected option's value is '5' (for "Foutieve invoer")
                            if ($(this).val() === '5') {
                                // Optional: populate modal body with specific text
                                $modalElement.find('.modal-body').html('<p>U heeft "Foutieve invoer" geselecteerd. Weet u zeker dat u wilt afsluiten met deze reden?</p>');
                                $modalElement.modal('show'); // Show the modal
                            }
                        });

                        // Click handler for the modal's confirm button
                        // This submits the form when the modal is confirmed.
                        $confirmButton.on('click', function() {
                            $formToConfirm.get(0).submit(); // Submit the form programmatically
                        });
                    } else {
                        // Log warnings if essential elements for the onchange confirmation are missing
                        if (!$afsluitingRedenDropdown.length) {
                            console.warn(`Dropdown met ID 'afsluiting_reden' niet gevonden. De 'onchange' bevestiging voor 'Foutieve invoer' werkt niet.`);
                        }
                        if (!$modalElement.length) {
                            console.warn(`Modal element met ID '${modalId}' niet gevonden. De 'onchange' bevestiging voor 'Foutieve invoer' werkt niet.`);
                        }
                        if ($modalElement.length && !$confirmButton.length) { // Modal exists but button is missing
                            console.warn(`Bevestigingsknop met ID '${confirmButtonId}' niet gevonden in modal '${modalId}'. De 'onchange' bevestiging voor 'Foutieve invoer' werkt niet.`);
                        }
                    }
                }
            });
        </script>
    {% endblock %}

{%- endblock form_start %}

{% block without_label %}
    {{ form_widget(form) }}
{% endblock without_label %}

{#Override form_label to not display empty div for empty label. Although it might break/alter display for forms the way one is used to... #}
{% block form_label -%}
    {%- if label is same as(false) -%}
        <div class=""></div>
    {%- else -%}
        {%- set label_attr = label_attr|merge({class: (label_attr.class|default('') ~ ' ' ~ block('form_label_class'))|trim}) -%}
        {{- parent() -}}
    {%- endif -%}
{%- endblock form_label %}

{#Seems redundant as it is the same as in the bootstrap layout? #}
{% block form_label_class -%}
    col-sm-2
{%- endblock form_label_class %}