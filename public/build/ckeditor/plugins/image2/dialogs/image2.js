CKEDITOR.dialog.add("image2",(function(t){function e(){var t=this.getValue().match(C);return(t=!(!t||0===parseInt(t[1],10)))||alert(_.invalidLength.replace("%1",_[this.id]).replace("%2","px")),t}function i(){var e=this.getValue(),i=t.config.image2_defaultLockRatio,a=void 0!==i;o(!1),e!==s.data.src?(u(e,(function(e,l,s){if(o(!0),!e)return n(!!a&&i);k.setValue(!1===t.config.image2_prefillDimensions?0:l),y.setValue(!1===t.config.image2_prefillDimensions?0:s),h=c=l,g=r=s,n(a?i:R.checkHasNaturalRatio(e))})),p=!0):p?(o(!0),k.setValue(c),y.setValue(r),p=!1):o(!0)}function a(){if(f&&((a=this.getValue())&&(a.match(C)||n(!1),"0"!==a))){var t="width"==this.id,e=c||h,i=r||g,a=t?Math.round(a/e*i):Math.round(a/i*e);isNaN(a)||(t?y:k).setValue(a)}}function n(t){if(b){if("boolean"==typeof t){if(m)return;f=t}else t=k.getValue(),m=!0,(f=!f)&&t&&(t*=r/c,isNaN(t)||y.setValue(Math.round(t)));b[f?"removeClass":"addClass"]("cke_btn_unlocked"),b.setAttribute("aria-checked",f),CKEDITOR.env.hc&&b.getChild(0).setHtml(f?CKEDITOR.env.ie?"■":"▣":CKEDITOR.env.ie?"□":"▢")}}function o(t){k[t=t?"enable":"disable"](),y[t]()}var l,s,d,u,c,r,h,g,p,f,m,b,v,k,y,V,C=/(^\s*(\d+)(px)?\s*$)|^$/i,w=CKEDITOR.tools.getNextId(),x=CKEDITOR.tools.getNextId(),D=t.lang.image2,_=t.lang.common,I=new CKEDITOR.template('<div><a href="javascript:void(0)" tabindex="-1" title="'+D.lockRatio+'" class="cke_btn_locked" id="{lockButtonId}" role="checkbox"><span class="cke_icon"></span><span class="cke_label">'+D.lockRatio+'</span></a><a href="javascript:void(0)" tabindex="-1" title="'+D.resetSize+'" class="cke_btn_reset" id="{resetButtonId}" role="button"><span class="cke_label">'+D.resetSize+"</span></a></div>").output({lockButtonId:w,resetButtonId:x}),R=CKEDITOR.plugins.image2,E=t.config,K=!(!E.filebrowserImageBrowseUrl&&!E.filebrowserBrowseUrl),T=t.widgets.registered.image.features,B=R.getNatural,O=[{id:"src",type:"text",label:_.url,onKeyup:i,onChange:i,setup:function(t){this.setValue(t.data.src)},commit:function(t){t.setData("src",this.getValue())},validate:CKEDITOR.dialog.validate.notEmpty(D.urlMissing)}];return K&&O.push({type:"button",id:"browse",style:"display:inline-block;margin-top:14px;",align:"center",label:t.lang.common.browseServer,hidden:!0,filebrowser:"info:src"}),{title:D.title,minWidth:250,minHeight:100,onLoad:function(){l=this._.element.getDocument(),u=function(){function t(t,a){i.push(e.once(t,(function(t){for(var e;e=i.pop();)e.removeListener();a(t)})))}var e=l.createElement("img"),i=[];return function(i,a,n){t("load",(function(){var t=B(e);a.call(n,e,t.width,t.height)})),t("error",(function(){a(null)})),t("abort",(function(){a(null)}));var o=-1!==i.indexOf("?")?"&":"?";e.setAttribute("src",(E.baseHref||"")+i+o+Math.random().toString(16).substring(2))}}()},onShow:function(){s=this.getModel(),d=s.parts.image,p=m=f=!1,V=B(d),h=c=V.width,g=r=V.height},contents:[{id:"info",label:D.infoTab,elements:[{type:"vbox",padding:0,children:[{type:"hbox",widths:["100%"],className:"cke_dialog_image_url",children:O}]},{id:"alt",type:"text",label:D.alt,setup:function(t){this.setValue(t.data.alt)},commit:function(t){t.setData("alt",this.getValue())},validate:!0===t.config.image2_altRequired?CKEDITOR.dialog.validate.notEmpty(D.altMissing):null},{type:"hbox",widths:["25%","25%","50%"],requiredContent:T.dimension.requiredContent,children:[{type:"text",width:"45px",id:"width",label:_.width,validate:e,onKeyUp:a,onLoad:function(){k=this},setup:function(t){this.setValue(t.data.width)},commit:function(t){t.setData("width",this.getValue())}},{type:"text",id:"height",width:"45px",label:_.height,validate:e,onKeyUp:a,onLoad:function(){y=this},setup:function(t){this.setValue(t.data.height)},commit:function(t){t.setData("height",this.getValue())}},{id:"lock",type:"html",style:"margin-top:18px;width:40px;height:20px;",onLoad:function(){function t(t){t.on("mouseover",(function(){this.addClass("cke_btn_over")}),t),t.on("mouseout",(function(){this.removeClass("cke_btn_over")}),t)}var e=this.getDialog();b=l.getById(w),v=l.getById(x),b&&(e.addFocusable(b,4+K),b.on("click",(function(t){n(),t.data&&t.data.preventDefault()}),this.getDialog()),t(b)),v&&(e.addFocusable(v,5+K),v.on("click",(function(t){p?(k.setValue(h),y.setValue(g)):(k.setValue(c),y.setValue(r)),t.data&&t.data.preventDefault()}),this),t(v))},setup:function(t){n(t.data.lock)},commit:function(t){t.setData("lock",f)},html:I}]},{type:"hbox",id:"alignment",requiredContent:T.align.requiredContent,children:[{id:"align",type:"radio",items:[[_.alignNone,"none"],[_.left,"left"],[_.center,"center"],[_.right,"right"]],label:_.align,setup:function(t){this.setValue(t.data.align)},commit:function(t){t.setData("align",this.getValue())}}]},{id:"hasCaption",type:"checkbox",label:D.captioned,requiredContent:T.caption.requiredContent,setup:function(t){this.setValue(t.data.hasCaption)},commit:function(t){t.setData("hasCaption",this.getValue())}}]},{id:"Upload",hidden:!0,filebrowser:"uploadButton",label:D.uploadTab,elements:[{type:"file",id:"upload",label:D.btnUpload,style:"height:40px"},{type:"fileButton",id:"uploadButton",filebrowser:"info:src",label:D.btnUpload,for:["Upload","upload"]}]}]}}));